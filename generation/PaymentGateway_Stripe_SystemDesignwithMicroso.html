<html><head><meta content="text/html; charset=UTF-8" http-equiv="content-type"><style type="text/css">@import url(https://themes.googleusercontent.com/fonts/css?kit=mW_CIZvkcW1i7Mw9mVo5Pw1nGhQimsDuvOKTiJCJG5Q);.lst-kix_lm6pr96k72sg-4>li:before{content:"-  "}.lst-kix_lm6pr96k72sg-6>li:before{content:"-  "}.lst-kix_rc0yxtwvfnue-8>li:before{content:"-  "}.lst-kix_lm6pr96k72sg-1>li:before{content:"-  "}.lst-kix_lm6pr96k72sg-5>li:before{content:"-  "}.lst-kix_lm6pr96k72sg-2>li:before{content:"-  "}.lst-kix_lm6pr96k72sg-3>li:before{content:"-  "}.lst-kix_rc0yxtwvfnue-2>li:before{content:"-  "}.lst-kix_rc0yxtwvfnue-1>li:before{content:"-  "}.lst-kix_rc0yxtwvfnue-0>li:before{content:"-  "}.lst-kix_lm6pr96k72sg-0>li:before{content:"-  "}ul.lst-kix_okmogo88k7jx-3{list-style-type:none}ul.lst-kix_okmogo88k7jx-4{list-style-type:none}ul.lst-kix_okmogo88k7jx-1{list-style-type:none}ul.lst-kix_okmogo88k7jx-2{list-style-type:none}ul.lst-kix_okmogo88k7jx-7{list-style-type:none}ul.lst-kix_okmogo88k7jx-8{list-style-type:none}ul.lst-kix_okmogo88k7jx-5{list-style-type:none}ul.lst-kix_okmogo88k7jx-6{list-style-type:none}.lst-kix_rc0yxtwvfnue-3>li:before{content:"-  "}.lst-kix_nj8bxwtwhhgr-0>li:before{content:"-  "}.lst-kix_nj8bxwtwhhgr-2>li:before{content:"-  "}.lst-kix_rc0yxtwvfnue-4>li:before{content:"-  "}.lst-kix_nj8bxwtwhhgr-1>li:before{content:"-  "}.lst-kix_lm6pr96k72sg-8>li:before{content:"-  "}.lst-kix_rc0yxtwvfnue-5>li:before{content:"-  "}.lst-kix_nj8bxwtwhhgr-4>li:before{content:"-  "}.lst-kix_rc0yxtwvfnue-7>li:before{content:"-  "}.lst-kix_lm6pr96k72sg-7>li:before{content:"-  "}.lst-kix_rc0yxtwvfnue-6>li:before{content:"-  "}.lst-kix_nj8bxwtwhhgr-3>li:before{content:"-  "}.lst-kix_wbbsqg40g50d-7>li:before{content:"-  "}.lst-kix_wbbsqg40g50d-8>li:before{content:"-  "}.lst-kix_wbbsqg40g50d-5>li:before{content:"-  "}.lst-kix_wbbsqg40g50d-6>li:before{content:"-  "}ul.lst-kix_w7caxix0xtog-7{list-style-type:none}ul.lst-kix_w7caxix0xtog-6{list-style-type:none}ul.lst-kix_w7caxix0xtog-8{list-style-type:none}ul.lst-kix_lyzxm2efvedy-7{list-style-type:none}ul.lst-kix_lyzxm2efvedy-6{list-style-type:none}ul.lst-kix_lyzxm2efvedy-5{list-style-type:none}ul.lst-kix_lyzxm2efvedy-4{list-style-type:none}ul.lst-kix_lyzxm2efvedy-8{list-style-type:none}ul.lst-kix_wdmvjol7rplb-4{list-style-type:none}ul.lst-kix_wdmvjol7rplb-3{list-style-type:none}ul.lst-kix_wdmvjol7rplb-6{list-style-type:none}ul.lst-kix_wdmvjol7rplb-5{list-style-type:none}ul.lst-kix_wdmvjol7rplb-0{list-style-type:none}ul.lst-kix_lyzxm2efvedy-3{list-style-type:none}ul.lst-kix_lyzxm2efvedy-2{list-style-type:none}ul.lst-kix_okmogo88k7jx-0{list-style-type:none}ul.lst-kix_wdmvjol7rplb-2{list-style-type:none}ul.lst-kix_lyzxm2efvedy-1{list-style-type:none}ul.lst-kix_wdmvjol7rplb-1{list-style-type:none}ul.lst-kix_lyzxm2efvedy-0{list-style-type:none}ul.lst-kix_wdmvjol7rplb-8{list-style-type:none}ul.lst-kix_wdmvjol7rplb-7{list-style-type:none}ul.lst-kix_rc0yxtwvfnue-0{list-style-type:none}ul.lst-kix_rc0yxtwvfnue-1{list-style-type:none}ul.lst-kix_rc0yxtwvfnue-2{list-style-type:none}ul.lst-kix_rc0yxtwvfnue-3{list-style-type:none}ul.lst-kix_rc0yxtwvfnue-8{list-style-type:none}ul.lst-kix_w7caxix0xtog-3{list-style-type:none}ul.lst-kix_w7caxix0xtog-2{list-style-type:none}ul.lst-kix_w7caxix0xtog-5{list-style-type:none}ul.lst-kix_w7caxix0xtog-4{list-style-type:none}ul.lst-kix_rc0yxtwvfnue-4{list-style-type:none}ul.lst-kix_rc0yxtwvfnue-5{list-style-type:none}ul.lst-kix_rc0yxtwvfnue-6{list-style-type:none}ul.lst-kix_w7caxix0xtog-1{list-style-type:none}ul.lst-kix_rc0yxtwvfnue-7{list-style-type:none}ul.lst-kix_w7caxix0xtog-0{list-style-type:none}.lst-kix_wdmvjol7rplb-7>li:before{content:"-  "}.lst-kix_q86qk5ucs3jo-3>li:before{content:"-  "}.lst-kix_q86qk5ucs3jo-5>li:before{content:"-  "}.lst-kix_wdmvjol7rplb-1>li:before{content:"-  "}.lst-kix_q86qk5ucs3jo-7>li:before{content:"-  "}.lst-kix_wbbsqg40g50d-0>li:before{content:"-  "}.lst-kix_wdmvjol7rplb-5>li:before{content:"-  "}.lst-kix_wbbsqg40g50d-2>li:before{content:"-  "}.lst-kix_wdmvjol7rplb-3>li:before{content:"-  "}.lst-kix_wbbsqg40g50d-4>li:before{content:"-  "}.lst-kix_q86qk5ucs3jo-1>li:before{content:"-  "}.lst-kix_lyzxm2efvedy-0>li:before{content:"-  "}.lst-kix_w7caxix0xtog-3>li:before{content:"-  "}.lst-kix_yehc7ddrfxqw-1>li:before{content:"-  "}.lst-kix_nj8bxwtwhhgr-8>li:before{content:"-  "}.lst-kix_lyzxm2efvedy-2>li:before{content:"-  "}.lst-kix_lyzxm2efvedy-4>li:before{content:"-  "}.lst-kix_w7caxix0xtog-1>li:before{content:"-  "}.lst-kix_w7caxix0xtog-5>li:before{content:"-  "}.lst-kix_w7caxix0xtog-7>li:before{content:"-  "}.lst-kix_nj8bxwtwhhgr-6>li:before{content:"-  "}.lst-kix_yehc7ddrfxqw-7>li:before{content:"-  "}.lst-kix_yehc7ddrfxqw-5>li:before{content:"-  "}.lst-kix_lyzxm2efvedy-6>li:before{content:"-  "}.lst-kix_lyzxm2efvedy-8>li:before{content:"-  "}.lst-kix_yehc7ddrfxqw-3>li:before{content:"-  "}.lst-kix_okmogo88k7jx-0>li:before{content:"-  "}.lst-kix_okmogo88k7jx-1>li:before{content:"-  "}.lst-kix_okmogo88k7jx-2>li:before{content:"-  "}.lst-kix_zfsqa2yodcl9-6>li:before{content:"-  "}.lst-kix_zfsqa2yodcl9-5>li:before{content:"-  "}.lst-kix_zfsqa2yodcl9-7>li:before{content:"-  "}.lst-kix_zfsqa2yodcl9-2>li:before{content:"-  "}.lst-kix_okmogo88k7jx-8>li:before{content:"-  "}.lst-kix_zfsqa2yodcl9-1>li:before{content:"-  "}.lst-kix_zfsqa2yodcl9-0>li:before{content:"-  "}.lst-kix_zfsqa2yodcl9-8>li:before{content:"-  "}.lst-kix_okmogo88k7jx-4>li:before{content:"-  "}.lst-kix_okmogo88k7jx-3>li:before{content:"-  "}.lst-kix_okmogo88k7jx-5>li:before{content:"-  "}.lst-kix_zfsqa2yodcl9-3>li:before{content:"-  "}.lst-kix_okmogo88k7jx-7>li:before{content:"-  "}.lst-kix_zfsqa2yodcl9-4>li:before{content:"-  "}.lst-kix_okmogo88k7jx-6>li:before{content:"-  "}ul.lst-kix_q86qk5ucs3jo-1{list-style-type:none}ul.lst-kix_q86qk5ucs3jo-0{list-style-type:none}ul.lst-kix_zfsqa2yodcl9-8{list-style-type:none}ul.lst-kix_zfsqa2yodcl9-4{list-style-type:none}ul.lst-kix_zfsqa2yodcl9-5{list-style-type:none}ul.lst-kix_zfsqa2yodcl9-6{list-style-type:none}ul.lst-kix_zfsqa2yodcl9-7{list-style-type:none}ul.lst-kix_q86qk5ucs3jo-3{list-style-type:none}ul.lst-kix_q86qk5ucs3jo-2{list-style-type:none}ul.lst-kix_q86qk5ucs3jo-5{list-style-type:none}ul.lst-kix_q86qk5ucs3jo-4{list-style-type:none}ul.lst-kix_q86qk5ucs3jo-7{list-style-type:none}ul.lst-kix_q86qk5ucs3jo-6{list-style-type:none}ul.lst-kix_q86qk5ucs3jo-8{list-style-type:none}ul.lst-kix_wbbsqg40g50d-0{list-style-type:none}ul.lst-kix_nj8bxwtwhhgr-0{list-style-type:none}ul.lst-kix_wbbsqg40g50d-1{list-style-type:none}ul.lst-kix_nj8bxwtwhhgr-1{list-style-type:none}.lst-kix_wdmvjol7rplb-8>li:before{content:"-  "}ul.lst-kix_wbbsqg40g50d-2{list-style-type:none}ul.lst-kix_wbbsqg40g50d-3{list-style-type:none}ul.lst-kix_lm6pr96k72sg-7{list-style-type:none}ul.lst-kix_wbbsqg40g50d-4{list-style-type:none}ul.lst-kix_lm6pr96k72sg-8{list-style-type:none}ul.lst-kix_nj8bxwtwhhgr-4{list-style-type:none}ul.lst-kix_wbbsqg40g50d-5{list-style-type:none}ul.lst-kix_lm6pr96k72sg-5{list-style-type:none}ul.lst-kix_nj8bxwtwhhgr-5{list-style-type:none}ul.lst-kix_wbbsqg40g50d-6{list-style-type:none}ul.lst-kix_lm6pr96k72sg-6{list-style-type:none}ul.lst-kix_nj8bxwtwhhgr-2{list-style-type:none}ul.lst-kix_wbbsqg40g50d-7{list-style-type:none}ul.lst-kix_lm6pr96k72sg-3{list-style-type:none}.lst-kix_q86qk5ucs3jo-8>li:before{content:"-  "}ul.lst-kix_nj8bxwtwhhgr-3{list-style-type:none}ul.lst-kix_wbbsqg40g50d-8{list-style-type:none}ul.lst-kix_lm6pr96k72sg-4{list-style-type:none}ul.lst-kix_nj8bxwtwhhgr-8{list-style-type:none}ul.lst-kix_zfsqa2yodcl9-0{list-style-type:none}ul.lst-kix_lm6pr96k72sg-1{list-style-type:none}ul.lst-kix_zfsqa2yodcl9-1{list-style-type:none}ul.lst-kix_lm6pr96k72sg-2{list-style-type:none}ul.lst-kix_nj8bxwtwhhgr-6{list-style-type:none}ul.lst-kix_zfsqa2yodcl9-2{list-style-type:none}ul.lst-kix_nj8bxwtwhhgr-7{list-style-type:none}ul.lst-kix_zfsqa2yodcl9-3{list-style-type:none}ul.lst-kix_lm6pr96k72sg-0{list-style-type:none}.lst-kix_wdmvjol7rplb-0>li:before{content:"-  "}.lst-kix_q86qk5ucs3jo-0>li:before{content:"-  "}.lst-kix_q86qk5ucs3jo-4>li:before{content:"-  "}.lst-kix_wdmvjol7rplb-6>li:before{content:"-  "}.lst-kix_q86qk5ucs3jo-6>li:before{content:"-  "}.lst-kix_wbbsqg40g50d-1>li:before{content:"-  "}.lst-kix_wdmvjol7rplb-4>li:before{content:"-  "}.lst-kix_wbbsqg40g50d-3>li:before{content:"-  "}.lst-kix_wdmvjol7rplb-2>li:before{content:"-  "}ul.lst-kix_yehc7ddrfxqw-8{list-style-type:none}.lst-kix_q86qk5ucs3jo-2>li:before{content:"-  "}ul.lst-kix_yehc7ddrfxqw-7{list-style-type:none}ul.lst-kix_yehc7ddrfxqw-6{list-style-type:none}ul.lst-kix_yehc7ddrfxqw-5{list-style-type:none}.lst-kix_yehc7ddrfxqw-0>li:before{content:"-  "}.lst-kix_yehc7ddrfxqw-2>li:before{content:"-  "}ul.lst-kix_yehc7ddrfxqw-4{list-style-type:none}ul.lst-kix_yehc7ddrfxqw-3{list-style-type:none}ul.lst-kix_yehc7ddrfxqw-2{list-style-type:none}ul.lst-kix_yehc7ddrfxqw-1{list-style-type:none}.lst-kix_w7caxix0xtog-2>li:before{content:"-  "}.lst-kix_w7caxix0xtog-6>li:before{content:"-  "}ul.lst-kix_yehc7ddrfxqw-0{list-style-type:none}.lst-kix_lyzxm2efvedy-1>li:before{content:"-  "}.lst-kix_lyzxm2efvedy-5>li:before{content:"-  "}.lst-kix_nj8bxwtwhhgr-5>li:before{content:"-  "}.lst-kix_yehc7ddrfxqw-6>li:before{content:"-  "}.lst-kix_nj8bxwtwhhgr-7>li:before{content:"-  "}.lst-kix_w7caxix0xtog-0>li:before{content:"-  "}.lst-kix_w7caxix0xtog-8>li:before{content:"-  "}.lst-kix_lyzxm2efvedy-3>li:before{content:"-  "}.lst-kix_yehc7ddrfxqw-4>li:before{content:"-  "}.lst-kix_w7caxix0xtog-4>li:before{content:"-  "}.lst-kix_lyzxm2efvedy-7>li:before{content:"-  "}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}.lst-kix_yehc7ddrfxqw-8>li:before{content:"-  "}ol{margin:0;padding:0}table td,table th{padding:0}.c9{padding-top:16pt;padding-bottom:4pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c0{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Ubuntu";font-style:normal}.c1{padding-top:18pt;padding-bottom:6pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c11{padding-top:14pt;padding-bottom:4pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c7{color:#000000;font-weight:700;text-decoration:none;vertical-align:baseline;font-size:16pt;font-family:"Ubuntu";font-style:normal}.c16{color:#000000;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Ubuntu";font-style:normal}.c12{color:#666666;text-decoration:none;vertical-align:baseline;font-size:12pt;font-family:"Ubuntu";font-style:normal}.c15{color:#434343;text-decoration:none;vertical-align:baseline;font-size:14pt;font-family:"Ubuntu";font-style:normal}.c2{padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c13{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.c14{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.c6{margin-left:36pt;padding-left:0pt}.c4{margin-left:72pt;padding-left:0pt}.c10{color:inherit;text-decoration:inherit}.c5{padding:0;margin:0}.c3{height:11pt}.c8{font-weight:700}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Ubuntu";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Ubuntu"}p{margin:0;color:#000000;font-size:11pt;font-family:"Ubuntu"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Ubuntu";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-weight:700;font-size:16pt;padding-bottom:6pt;font-family:"Ubuntu";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-weight:700;font-size:14pt;padding-bottom:4pt;font-family:"Ubuntu";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-weight:700;font-size:12pt;padding-bottom:4pt;font-family:"Ubuntu";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Ubuntu";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Ubuntu";line-height:1.15;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c14 doc-content"><h2 class="c1" id="h.ksnbqlwg8l28"><span class="c7">Introduction</span></h2><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">Payment Gateway system design is pretty similar to Bank system design, with a lot of problems and complexities in common. The goal of the system is to allow businesses to make money out of goods/services by processing payments for them. </span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">We are going to design a full lifecycle starting from card details submitted by the customer ending with sending money to the merchant.</span></p><p class="c2"><span class="c0">Note, that this system design requires a bit of domain knowledge about how payments, card networks and banks are working - you can find a very short section about it below.</span></p><p class="c2 c3"><span class="c0"></span></p><h2 class="c1" id="h.ysn8f2tncnhn"><span class="c7">Domain Background</span></h2><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">As I was mentioning for this system design you will need a bit of background knowledge about payment processing, card networks and banks.</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">Stripe is not a bank. It is an intermediary that helps move money from customer cards to merchant bank accounts.</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">Why are people using Stripe and not implementing their own payment processing? Because in order to store and process card details, payments, and integrate with Card Networks and banks you will need to acquire tons of licenses, which is both time consuming and very expensive. Besides that &nbsp;you will pay huge fines if you don&rsquo;t follow high standards.</span></p><p class="c2 c3"><span class="c0"></span></p><h3 class="c9" id="h.80q60453a2l1"><span class="c15 c8">Terminology</span></h3><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c8">Merchant&rsquo;s Customer</span><span class="c0">&nbsp;- our skip customers who want to buy goods / services.</span></p><p class="c2"><span class="c8">Merchant</span><span class="c0">&nbsp;- our direct customer that sells some goods or services</span></p><p class="c2"><span class="c8">Stripe</span><span class="c0">&nbsp;- us, Payment Gateway acts as the payment gateway and payment processor</span></p><p class="c2"><span class="c8">Acquiring bank</span><span class="c0">&nbsp;- Stripe&rsquo;s (receiving) bank</span></p><p class="c2"><span class="c8">Card network</span><span class="c0">&nbsp;- Card payments processor, e.g. Visa, Mastercard, etc.</span></p><p class="c2"><span class="c8">Issuing bank</span><span class="c0">&nbsp;- the skip customer&rsquo;s bank. It issued a card the customer is paying with.</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c8">Payout</span><span class="c0">&nbsp;- settling money from Stripe bank to Merchant&rsquo;s bank.</span></p><p class="c2"><span class="c8">Ledger</span><span class="c0">&nbsp;- is a financial record system that tracks all transactions as paired entries - a debit and a credit (e.g., acc1 -$100; acc2 +$100). This two-sided format ensures every movement of money is balanced and traceable. It&rsquo;s a legal requirement for payment processors, and all entries together should sum to zero.</span></p><p class="c2 c3"><span class="c0"></span></p><h3 class="c9" id="h.m883d8ft524q"><span class="c15 c8">Flow</span></h3><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">In general, flow looks like that:</span></p><p class="c2"><span class="c0">1. The customer wants to pay with a card, so the merchant creates Payment (payment intent) in Stripe.</span></p><p class="c2"><span class="c0">2. Stripe sends the request to Card Network (Visa, MasterCard), as we are working with card details, not bank accounts.</span></p><p class="c2"><span class="c0">3. Card Network transfers money from the customer&#39;s bank (issuing bank) to Stripe&rsquo;s bank (acquiring bank).</span></p><p class="c2"><span class="c0">4. Stripe records transaction in internal ledger, and charges the fee for money transfer</span></p><p class="c2"><span class="c0">5. Stripe performs payment from its bank ( to merchant&rsquo;s bank account (payout)</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">Money transfer from customer to Stripe&rsquo;s bank is performed using 3 steps:</span></p><ul class="c5 lst-kix_zfsqa2yodcl9-0 start"><li class="c2 c6 li-bullet-0"><span class="c0">authorization transaction, which locks money on customer&rsquo;s account, performs fraud check, etc</span></li><li class="c2 c6 li-bullet-0"><span class="c0">capture request, idempotent request that actually confirms authorized transaction. It means money must be moved from sender to receiver</span></li><li class="c2 c6 li-bullet-0"><span class="c0">settlement - is the final stage when the bank is moving money from one account to another account.</span></li></ul><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">You can think about it as follows:</span></p><ul class="c5 lst-kix_okmogo88k7jx-0 start"><li class="c2 c6 li-bullet-0"><span class="c0">authorization is operation in SQL transaction</span></li><li class="c2 c6 li-bullet-0"><span class="c0">capturing is transaction&rsquo;s commit</span></li><li class="c2 c6 li-bullet-0"><span class="c0">settlement is replicating this commit to the follower node.</span></li></ul><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">Resources:</span></p><ul class="c5 lst-kix_nj8bxwtwhhgr-0 start"><li class="c2 c6 li-bullet-0"><span class="c13"><a class="c10" href="https://www.google.com/url?q=https://stripe.com/gb/resources/more/how-do-debit-card-payments-work-here-is-what-businesses-need-to-know&amp;sa=D&amp;source=editors&amp;ust=1764673900202228&amp;usg=AOvVaw32QADX8p-zg3W_L2mgNkqb">Stripe: debit card payment</a></span></li><li class="c2 c6 li-bullet-0"><span class="c13"><a class="c10" href="https://www.google.com/url?q=https://stripe.com/en-cz/resources/more/how-do-credit-card-networks-work&amp;sa=D&amp;source=editors&amp;ust=1764673900202549&amp;usg=AOvVaw3BL1JHZwnE8MZNQb7hUThD">Stripe: credit card payment</a></span></li><li class="c2 c6 li-bullet-0"><span class="c13"><a class="c10" href="https://www.google.com/url?q=https://stripe.com/en-cz/resources/more/credit-card-payment-authorization-and-transaction-settlement-process%23what-is-capturing-and-settlement&amp;sa=D&amp;source=editors&amp;ust=1764673900202946&amp;usg=AOvVaw2k1Ju3iME5KTyis-5EN6lk">Stripe: authorisation, capturing and settlement</a></span></li></ul><p class="c2 c3"><span class="c0"></span></p><h3 class="c9" id="h.tnlaku77o8vb"><span class="c15 c8">Reconciliation</span></h3><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">Once per couple of days banks are comparing their Ledger logs between each other to detect inconsistencies and rollback or rollout some of the transactions. That&rsquo;s because banks communicate between each other asynchronously, and this is the only way to keep the state consistent.</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">Stripe, as payment processor, should perform regular reconciliation as well, especially in case of payouts to synchronize money between internal ledger&rsquo;s transactions and merchant banks.</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2 c3"><span class="c0"></span></p><h2 class="c1" id="h.5f03dijeoybo"><span class="c7">Requirements</span></h2><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">As always, we are following our plan:</span></p><ul class="c5 lst-kix_yehc7ddrfxqw-0 start"><li class="c2 c6 li-bullet-0"><span class="c0">define functional and non-functional requirements</span></li><li class="c2 c6 li-bullet-0"><span class="c0">satisfy functional requirements</span></li><li class="c2 c6 li-bullet-0"><span class="c0">satisfy non-functional requirements</span></li><li class="c2 c6 li-bullet-0"><span class="c0">follow ups</span></li></ul><p class="c2 c3"><span class="c0"></span></p><h3 class="c9" id="h.py00ubsv4ikk"><span class="c15 c8">Functional Requirements</span></h3><ul class="c5 lst-kix_w7caxix0xtog-0 start"><li class="c2 c6 li-bullet-0"><span class="c0">Merchant is able to register itself and webhook</span></li><li class="c2 c6 li-bullet-0"><span class="c0">Customers are able to pay for merchant&rsquo;s goods/services</span></li><li class="c2 c6 li-bullet-0"><span class="c0">Merchant receives webhooks about its payment</span></li><li class="c2 c6 li-bullet-0"><span class="c0">Merchant is getting money for goods/services on its bank account via Payout mechanism</span></li><li class="c2 c6 li-bullet-0"><span class="c0">Ensure no double charge for the same item of good/service</span></li><li class="c2 c6 li-bullet-0"><span class="c0">Audit - all transactions are stored in Ledger (legal requirement)</span></li></ul><p class="c2 c3"><span class="c0"></span></p><h3 class="c9" id="h.nmu49a1e64iq"><span class="c15 c8">Non-Functional Requirements</span></h3><ul class="c5 lst-kix_lm6pr96k72sg-0 start"><li class="c2 c6 li-bullet-0"><span class="c0">High Traffic:</span></li></ul><ul class="c5 lst-kix_lm6pr96k72sg-1 start"><li class="c2 c4 li-bullet-0"><span>500 M payment requests per day =&gt; 5787 rps =&gt; </span><span class="c8">10k rps</span><span class="c0">&nbsp;on peaks</span></li><li class="c2 c4 li-bullet-0"><span>5B ledger events (change of transaction/payment state) per day =&gt; 57870 =&gt; </span><span class="c8">100k rps</span><span class="c0">&nbsp;on peaks</span></li><li class="c2 c4 li-bullet-0"><span class="c8 c16">2M merchants</span></li></ul><ul class="c5 lst-kix_lm6pr96k72sg-0"><li class="c2 c6 li-bullet-0"><span class="c0">CAP, availability vs consistency:</span></li></ul><ul class="c5 lst-kix_lm6pr96k72sg-1 start"><li class="c2 c4 li-bullet-0"><span>as </span><span class="c8">highly available</span><span class="c0">&nbsp;as possible</span></li><li class="c2 c4 li-bullet-0"><span class="c8">Strong consistency</span><span class="c0">&nbsp;(linearizability) for payment processing (no double charge)</span></li><li class="c2 c4 li-bullet-0"><span class="c8">Eventual consistency</span><span class="c0">&nbsp;for merchant&rsquo;s related data, and ledger data</span></li><li class="c2 c4 li-bullet-0"><span class="c8">No data loss </span><span class="c0">for ledger entries</span></li></ul><ul class="c5 lst-kix_lm6pr96k72sg-0"><li class="c2 c6 li-bullet-0"><span class="c0">Correctness: </span></li></ul><ul class="c5 lst-kix_lm6pr96k72sg-1 start"><li class="c2 c4 li-bullet-0"><span class="c0">debit and credit add up to zero</span></li><li class="c2 c4 li-bullet-0"><span class="c0">merchant receives webhook with &ldquo;at least once&rdquo; guarantee, retrying 30 days.</span></li></ul><ul class="c5 lst-kix_lm6pr96k72sg-0"><li class="c2 c6 li-bullet-0"><span class="c0">Spikes: uneven per season (black Friday), and per merchant</span></li></ul><p class="c2 c3"><span class="c0"></span></p><p class="c2 c3"><span class="c0"></span></p><h2 class="c1" id="h.e0b512tkk16b"><span class="c7">Satisfy Functional Requirements</span></h2><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">Let&rsquo;s try to design a system for a couple of users on a single machine just to make sure it will work and satisfy Functional requirements, then follow up with Non Functional requirements.</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 448.00px;"><img alt="" src="images/image13.png" style="width: 624.00px; height: 448.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c2 c3"><span class="c0"></span></p><h3 class="c9" id="h.8myda4vg4i8z"><span class="c15 c8">Merchant is able to register itself and webhook</span></h3><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">We can trivially satisfy this with simple API and storage. One endpoint that receives Merchant related information and stores it in a storage. In the real world it will be different types of data, e.g. webhook details, goods, logos, names, payment methods, etc. For security reasons we add api keys/secrets for API endpoints + signature for webhook validation.</span></p><p class="c2"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 394.67px;"><img alt="" src="images/image10.png" style="width: 624.00px; height: 394.67px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><h3 class="c9" id="h.3d83fyh77q85"><span class="c15 c8">Customers are able to pay for merchant&rsquo;s goods/services</span></h3><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">There is a sequence of steps needed to be performed to move money from customer to merchant&rsquo;s bank.</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">Step 1. The customer goes to the page of payment details, expressing willingness to pay. This action sends a request to our Payment API</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">Step 2. API creates a payment entity with status &ldquo;new&rdquo;, merchant/goods related information. It will be used for deduplication later.</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">Step 3. The customer initiates payment by filling in card details and pressing the &ldquo;Pay&rdquo;. The client should encrypt data and send it along with the payment id created earlier.</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">Step 4. Payment API sends &ldquo;Authorization&rdquo; request to Card Network with customer&rsquo;s card details. This step might include interactive flow and prompt customers to enter code, or confirm from the app. That flow will work on redirections the same way as OAuth.</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">Step 5. API saves the result of the Authorization transaction with &ldquo;auth_id&rdquo; to the database and updates status to &ldquo;authorized&rdquo;. Authorization id is a deduplication mechanism on Card Networks (see later).</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">Step 6. Payment API sends a &ldquo;Capture&rdquo; request to Card Network to move authorized money initialized by merchant, background job or within the same request straight away.</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">Step 7. The server saves &ldquo;Captured&rdquo; status to the payment in storage.</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">Step 8. Later on, the payout to merchants is happening via a background job that sends a batch of payments to the Merchant&rsquo;s bank.</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">During step 1 - &nbsp;step 7 inclusively, two extra steps are done every time: </span></p><ul class="c5 lst-kix_wbbsqg40g50d-0 start"><li class="c2 c6 li-bullet-0"><span class="c0">sending an event to Merchant&rsquo;s webhook.</span></li><li class="c2 c6 li-bullet-0"><span class="c0">store transaction/event to Audit storage</span></li></ul><p class="c2 c3"><span class="c0"></span></p><p class="c2 c3"><span class="c0"></span></p><h3 class="c9" id="h.kyjgo99sk0ln"><span class="c15 c8">Merchant receives webhooks about its payment</span></h3><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">As shown in the diagram webhook to Merchant&rsquo;s API is sent on every payment update or event.</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2 c3"><span class="c0"></span></p><h3 class="c9" id="h.oy25d4w3o2kt"><span class="c15 c8">Merchant is getting money for goods/services on its bank account via Payout mechanism</span></h3><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">At step 8, the money is transferred from Stripe&#39;s account to Merchant&rsquo;s account via payout. Every now and then we collect all successful payments and transfer them to the merchant&#39;s bank by batch (with retries and reconciliation).</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 385.33px;"><img alt="" src="images/image5.png" style="width: 624.00px; height: 385.33px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><h3 class="c9" id="h.cx28u5upqscn"><span class="c15 c8">Ensure no double charge for the same item of good/service</span></h3><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">Two step card payment (auth, capture) is helping here a lot. On our side, as we have unique payment ids, double charge can happen only in case of concurrent requests / retries from the client.</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">We will use Optimistic concurrency with Compare-and-swap (CAS) for that. When customer clicked &ldquo;Pay&rdquo; (POST /payment/:id) first we set status of the payment to &ldquo;Authorizing&rdquo;<br></span></p><p class="c2"><span class="c0">```sql<br>UPDATE payments SET status = &lsquo;authorizing&rsquo; WHERE id = $id AND status = &lsquo;new&rsquo;</span></p><p class="c2"><span class="c0">```</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">Only in case of success (rows affected &gt; 0) - we proceed to sending &ldquo;Auth&rdquo; requests to Card Network. This way if 2 concurrent threads try to call this endpoint for the same payment ID (client is retrying / concurrency issue) - only one of them will proceed with actually &ldquo;Authorizing&rdquo; and locking the customer&#39;s money.</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">When we got response from Card Network, we update payments again</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">```sql<br>UPDATE payments SET status = &lsquo;authorized&rsquo; auth_id = $auth_id WHERE id = $id AND status = &lsquo;authorizing&rsquo;</span></p><p class="c2"><span class="c0">```</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">Capturing then is idempotent on the Card Network side, so we can send multiple &ldquo;capture&rdquo; requests for the same auth_id and be on the safe side.</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2 c3"><span class="c0"></span></p><h3 class="c9" id="h.htch8lwf1q1p"><span class="c15 c8">Audit - all transactions are stored in Ledger</span></h3><p class="c2 c3"><span class="c0"></span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">As shown in the diagram we are writing a ledger entry to Audit Storage on every payment update or event.</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 433.33px;"><img alt="" src="images/image8.png" style="width: 624.00px; height: 433.33px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><h3 class="c9" id="h.4mzlibbl5vmr"><span class="c15 c8">Drawbacks</span></h3><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">Current architecture will work in a happy path and low traffic, but it has a lot of flawns:</span></p><ul class="c5 lst-kix_q86qk5ucs3jo-0 start"><li class="c2 c6 li-bullet-0"><span class="c0">How to handle payouts failures? What if the bank acknowledged it but the background job died before saving it to the database? How in general ensure the bank has the same payouts as our internal storage?</span></li></ul><ul class="c5 lst-kix_rc0yxtwvfnue-0 start"><li class="c2 c6 li-bullet-0"><span class="c0">How to guarantee webhook delivery to merchants if the merchant API is down for one day?</span></li><li class="c2 c6 li-bullet-0"><span class="c0">What to do if API died before sending transaction data to Audit storage? In that case we violate the law by not having full ledger logs.</span></li><li class="c2 c6 li-bullet-0"><span class="c0">Scalability / Availability issues are still there. We cannot afford more than a few thousands payments per second, and we cannot failover in case some component stopped working.</span></li></ul><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">Don&rsquo;t worry all of these points are covered in the section below.</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2 c3"><span class="c0"></span></p><h2 class="c1" id="h.qfq8uvyhw3qh"><span class="c7">Satisfy Non-Functional Requirements</span></h2><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">Now that our system works on a couple of users and a couple of machines, let&rsquo;s make it Stripe&rsquo;s size.</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 416.00px;"><img alt="" src="images/image4.png" style="width: 624.00px; height: 416.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c2 c3"><span class="c0"></span></p><h3 class="c9" id="h.789lbklo2cef"><span class="c15 c8">Introduce Kafka for side effects</span></h3><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">Before deep diving into non functional requirements I would like to add one pattern that will ease our life. You can see that when customer pays money we have a lot of side effects:</span></p><ul class="c5 lst-kix_wdmvjol7rplb-0 start"><li class="c2 c6 li-bullet-0"><span class="c0">sending webhook to merchant</span></li><li class="c2 c6 li-bullet-0"><span class="c0">save payment update to audit log</span></li><li class="c2 c6 li-bullet-0"><span class="c0">it might be more, e.g. notifications, some derived storages, etc</span></li></ul><p class="c2"><span class="c0">These operations are independent and can be randomly failed, delayed.</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">Therefore let&rsquo;s introduce a well known pattern: message broker with multiple workers per side effect.</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 386.67px;"><img alt="" src="images/image6.png" style="width: 624.00px; height: 386.67px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c2 c3"><span class="c0"></span></p><h3 class="c9" id="h.psj67y19qz8k"><span class="c15 c8">Correctness</span></h3><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">To guarantee at least one delivery to a Merchant&#39;s Webhook we need to store information about webhook delivery, as workers can randomly die, merchant API might be down for hours/days, etc.</span></p><p class="c2"><span class="c0">Since we cannot lose data for our Audit requirements, we are using the same mechanism here as well with &ldquo;at least once&rdquo; semantics (basically retry infinitely).</span></p><p class="c2"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 393.33px;"><img alt="" src="images/image3.png" style="width: 624.00px; height: 393.33px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2 c3"><span class="c0"></span></p><h3 class="c9" id="h.qtlgh75qgvnr"><span class="c15 c8">High Traffic &amp; Scalability</span></h3><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">A typical strategy for scaling traffic is to distribute the load as evenly as possible between the machines. It applies for both storage and compute.</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2 c3"><span class="c0"></span></p><h4 class="c11" id="h.fzixs4nm6jjm"><span class="c12 c8">Payment API</span></h4><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">Since stateless - trivially scaled with adding more instances in multiple regions/geos along with loadbalancers.</span></p><p class="c2"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 196.00px;"><img alt="" src="images/image11.png" style="width: 624.00px; height: 196.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c2 c3"><span class="c0"></span></p><h4 class="c11" id="h.1lcnszvh81dr"><span class="c12 c8">Payment Storage</span></h4><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">Since our load is write heavy mostly - we are applying sharding along with consistent/rendezvous hashing for rebalancing. The key would be payment id for even distribution of the records, as merchants are hotspotted and can overload single instances (if they are too big).<br></span></p><p class="c2"><span>However, you might say that it will create scatter/gather load on our shards for Merchant&rsquo;s dashboard, and you will be right, this is a scalability bottleneck.</span><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 422.67px;"><img alt="" src="images/image1.png" style="width: 624.00px; height: 422.67px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span><span class="c0">&nbsp;Another problem here, that if we shard by payment id, how is our coordinator/client going to know where a specific merchant&rsquo;s data is located?</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">The best approach here would be to use derived data and sync the payments data to another storage that is optimized for querying, aggregation and will be sharded by merchant id. Let&rsquo;s name such storage &ldquo;Merchant Storage&rdquo;, and move all merchant related data along with payments needed for the merchant dashboard there.</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2 c3"><span class="c0"></span></p><h4 class="c11" id="h.4tt30vtxt387"><span class="c12 c8">Merchant Storage</span></h4><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">As discussed above - we are sharding it by merchant id because we want to retrieve merchant related data. For rebalancing - well known consistent/rendezvous hashing. For too hot merchants - we can isolate them and handle them separately as per &ldquo;celebrity problem&rdquo;.</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 224.00px;"><img alt="" src="images/image9.png" style="width: 624.00px; height: 224.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2 c3"><span class="c0"></span></p><h4 class="c11" id="h.azad7kr6o5ty"><span class="c12 c8">Audit Storage</span></h4><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">We don&rsquo;t know how this database is going to be queried, so it is not easy to come up with a universal sharding strategy here. Let&rsquo;s add sharding by payment, same as our Payment Storage. This will be enough to prove that it will scale well. If the intention is to query it by some ranges, run aggregations - then something more advanced should be done as a sharding strategy.</span></p><p class="c2 c3"><span class="c0"></span></p><h4 class="c11" id="h.r905lr9k5av"><span class="c12 c8">PaymentEvents Queue</span></h4><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">Kafka is trivially getting sharded (partitioned) &nbsp;by payment id for ordering within the same payment.</span></p><p class="c2 c3"><span class="c0"></span></p><h4 class="c11" id="h.xsz28p4bit26"><span class="c12 c8">Workers, background job</span></h4><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">The workers are trivially scaled together with kafka partitions as they are stateless computes.</span></p><p class="c2 c3"><span class="c0"></span></p><h4 class="c11" id="h.wht8lehgfnla"><span class="c12 c8">Retry/Job Storage</span></h4><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">The storage can be sharded by job id trivially as well. Background jobs might query the job by &ldquo;type&rdquo; field from multiple shards. We will just apply an index on top of it.</span></p><p class="c2 c3"><span class="c0"></span></p><h3 class="c9" id="h.x9uk05rymmjt"><span class="c8 c15">CAP, availability vs consistency</span></h3><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">For sure we want our Stripe to never be down. This section covers high availability of our components.</span></p><p class="c2 c3"><span class="c0"></span></p><h4 class="c11" id="h.li93xgys2sut"><span class="c12 c8">Payment API</span></h4><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">Already solved by scaling (replication), as it is stateless.</span></p><p class="c2 c3"><span class="c0"></span></p><h4 class="c11" id="h.buj5x7mw849t"><span class="c12 c8">Payment Storage</span></h4><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">First of all, we are not allowed to lose payment data, so we cannot use Leader-Follower replication.</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">We have to provide a &nbsp;linearizability consistency guarantee here, because we process the payments and we are relying on their &ldquo;freshness&rdquo;. Without recency guarantee we will be doing unnecessary operations to Card Network.</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">So the call here is Consensus based replication (Raft, Paxos).</span></p><hr style="page-break-before:always;display:none;"><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 360.00px;"><img alt="" src="images/image7.png" style="width: 624.00px; height: 360.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c2 c3"><span class="c0"></span></p><h4 class="c11" id="h.grdw3acq33c1"><span class="c12 c8">Merchant Storage</span></h4><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">This is fully eventually consistent storage, as it is not critical if payment info will appear 1-2 hours later than it actually happened. Therefore the natural solution for availability is Leader-Follower async replication. The only problem here is possible data loss. I believe we can pursue the Product people that it is okay to lose data for the merchant dashboard. If not - then we can do the same consensus algorithm as above, or Leader-Leader/Leaderless.</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">Anyway the actual payment is based on Audit storage, not Merchant storage.</span></p><p class="c2 c3"><span class="c0"></span></p><h4 class="c11" id="h.buaqycaqfb2k"><span class="c12 c8">Audit Storage</span></h4><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">Leader-Follower replication is not feasible here, because we have legal requirements to not lose data in this storage. However we don&rsquo;t have to be linearizable either, cause we only syncing data into one place, meaning we are eventually consistent.</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">The solution here is Leaderless or Leader-Leader replication. We can afford it because we won&rsquo;t have concurrency on the same PaymentUpdate object/row, and we don&rsquo;t make decisions based on its data.</span></p><p class="c2"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 285.33px;"><img alt="" src="images/image12.png" style="width: 624.00px; height: 285.33px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c2 c3"><span class="c0"></span></p><h4 class="c11" id="h.komh3auda50q"><span class="c12 c8">Payment Events Queue</span></h4><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">We can easily add more replicas to kafka with quorum to not lose data and be highly available.</span></p><p class="c2 c3"><span class="c0"></span></p><h4 class="c11" id="h.4rxikp1m68ic"><span class="c12 c8">Workers, background job</span></h4><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">Can easily be replicated as Payment API, since stateless. We have &nbsp;at least once delivery - we are good to go and to not worry about double processing.</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 264.00px;"><img alt="" src="images/image2.png" style="width: 624.00px; height: 264.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c2 c3"><span class="c0"></span></p><h4 class="c11" id="h.wz36wam85n87"><span class="c8 c12">Retry/Job Storage</span></h4><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">Since we have &ldquo;at least once&rdquo; guarantee here. We cannot lose the data in this storage. However, with background job semantics we also don&rsquo;t need linearizability. Therefore here we can use either leaderless or leader-leader.</span></p><p class="c2 c3"><span class="c0"></span></p><p class="c2 c3"><span class="c0"></span></p><h2 class="c1" id="h.de0dnkqucun7"><span class="c7">Conclusion</span></h2><p class="c2 c3"><span class="c0"></span></p><p class="c2"><span class="c0">I hope you find this system design useful, please share your thoughts on the decisions made here in the comment section or in my social media.<br><br>Don&rsquo;t forget to subscribe to not miss next system design problems.</span></p></body></html>