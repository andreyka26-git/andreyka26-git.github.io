<html><head><meta content="text/html; charset=UTF-8" http-equiv="content-type"><style type="text/css">@import url(https://themes.googleusercontent.com/fonts/css?kit=mW_CIZvkcW1i7Mw9mVo5Pw1nGhQimsDuvOKTiJCJG5Q);.lst-kix_a7vqfvyrill0-5>li:before{content:"-  "}ol.lst-kix_99al7u6eb175-4{list-style-type:none}.lst-kix_n1ot8ade5hg0-5>li:before{content:"-  "}ol.lst-kix_99al7u6eb175-5{list-style-type:none}ol.lst-kix_99al7u6eb175-2{list-style-type:none}.lst-kix_n1ot8ade5hg0-4>li:before{content:"-  "}.lst-kix_n1ot8ade5hg0-6>li:before{content:"-  "}.lst-kix_ko0xls73w40n-0>li:before{content:"-  "}.lst-kix_ko0xls73w40n-2>li:before{content:"-  "}ol.lst-kix_99al7u6eb175-3{list-style-type:none}.lst-kix_a7vqfvyrill0-3>li:before{content:"-  "}.lst-kix_a7vqfvyrill0-7>li:before{content:"-  "}ol.lst-kix_99al7u6eb175-8{list-style-type:none}.lst-kix_a7vqfvyrill0-4>li:before{content:"-  "}.lst-kix_a7vqfvyrill0-8>li:before{content:"-  "}ol.lst-kix_99al7u6eb175-6{list-style-type:none}.lst-kix_ko0xls73w40n-1>li:before{content:"-  "}ol.lst-kix_99al7u6eb175-7{list-style-type:none}.lst-kix_n1ot8ade5hg0-1>li:before{content:"-  "}.lst-kix_n1ot8ade5hg0-0>li:before{content:"-  "}.lst-kix_n1ot8ade5hg0-8>li:before{content:"-  "}.lst-kix_ko0xls73w40n-6>li:before{content:"-  "}ol.lst-kix_l4f0b27zjaea-3.start{counter-reset:lst-ctn-kix_l4f0b27zjaea-3 0}.lst-kix_n1ot8ade5hg0-7>li:before{content:"-  "}.lst-kix_a7vqfvyrill0-6>li:before{content:"-  "}ol.lst-kix_99al7u6eb175-3.start{counter-reset:lst-ctn-kix_99al7u6eb175-3 0}.lst-kix_ko0xls73w40n-7>li:before{content:"-  "}.lst-kix_ko0xls73w40n-8>li:before{content:"-  "}ol.lst-kix_l4f0b27zjaea-0.start{counter-reset:lst-ctn-kix_l4f0b27zjaea-0 0}.lst-kix_a7vqfvyrill0-0>li:before{content:"-  "}ol.lst-kix_99al7u6eb175-6.start{counter-reset:lst-ctn-kix_99al7u6eb175-6 0}.lst-kix_a7vqfvyrill0-1>li:before{content:"-  "}.lst-kix_a7vqfvyrill0-2>li:before{content:"-  "}.lst-kix_99al7u6eb175-8>li:before{content:"" counter(lst-ctn-kix_99al7u6eb175-8,lower-roman) ". "}.lst-kix_l4f0b27zjaea-1>li:before{content:"" counter(lst-ctn-kix_l4f0b27zjaea-1,lower-latin) ". "}.lst-kix_l4f0b27zjaea-2>li:before{content:"" counter(lst-ctn-kix_l4f0b27zjaea-2,lower-roman) ". "}ul.lst-kix_9w5i4ehhau0k-7{list-style-type:none}.lst-kix_q7lc7dosa7qm-3>li:before{content:"-  "}.lst-kix_q7lc7dosa7qm-5>li:before{content:"-  "}.lst-kix_agh5cx7a3fgl-8>li:before{content:"-  "}ul.lst-kix_9w5i4ehhau0k-8{list-style-type:none}.lst-kix_l4f0b27zjaea-3>li:before{content:"" counter(lst-ctn-kix_l4f0b27zjaea-3,decimal) ". "}.lst-kix_99al7u6eb175-7>li:before{content:"" counter(lst-ctn-kix_99al7u6eb175-7,lower-latin) ". "}.lst-kix_q7lc7dosa7qm-4>li:before{content:"-  "}.lst-kix_q7lc7dosa7qm-8>li:before{content:"-  "}ul.lst-kix_9w5i4ehhau0k-1{list-style-type:none}.lst-kix_99al7u6eb175-4>li:before{content:"" counter(lst-ctn-kix_99al7u6eb175-4,lower-latin) ". "}.lst-kix_99al7u6eb175-5>li:before{content:"" counter(lst-ctn-kix_99al7u6eb175-5,lower-roman) ". "}ul.lst-kix_9w5i4ehhau0k-2{list-style-type:none}.lst-kix_q7lc7dosa7qm-7>li:before{content:"-  "}ul.lst-kix_9w5i4ehhau0k-0{list-style-type:none}ul.lst-kix_9w5i4ehhau0k-5{list-style-type:none}.lst-kix_l4f0b27zjaea-0>li:before{content:"" counter(lst-ctn-kix_l4f0b27zjaea-0,decimal) ". "}.lst-kix_l4f0b27zjaea-8>li:before{content:"" counter(lst-ctn-kix_l4f0b27zjaea-8,lower-roman) ". "}.lst-kix_99al7u6eb175-6>li:before{content:"" counter(lst-ctn-kix_99al7u6eb175-6,decimal) ". "}ul.lst-kix_9w5i4ehhau0k-6{list-style-type:none}ul.lst-kix_9w5i4ehhau0k-3{list-style-type:none}.lst-kix_q7lc7dosa7qm-6>li:before{content:"-  "}ul.lst-kix_9w5i4ehhau0k-4{list-style-type:none}.lst-kix_99al7u6eb175-0>li:before{content:"" counter(lst-ctn-kix_99al7u6eb175-0,decimal) ". "}.lst-kix_99al7u6eb175-1>li:before{content:"" counter(lst-ctn-kix_99al7u6eb175-1,lower-latin) ". "}.lst-kix_9w5i4ehhau0k-0>li:before{content:"-  "}.lst-kix_9w5i4ehhau0k-2>li:before{content:"-  "}.lst-kix_l4f0b27zjaea-0>li{counter-increment:lst-ctn-kix_l4f0b27zjaea-0}.lst-kix_l4f0b27zjaea-7>li:before{content:"" counter(lst-ctn-kix_l4f0b27zjaea-7,lower-latin) ". "}.lst-kix_99al7u6eb175-3>li:before{content:"" counter(lst-ctn-kix_99al7u6eb175-3,decimal) ". "}.lst-kix_q7lc7dosa7qm-0>li:before{content:"-  "}.lst-kix_ko0xls73w40n-5>li:before{content:"-  "}.lst-kix_9w5i4ehhau0k-1>li:before{content:"-  "}.lst-kix_l4f0b27zjaea-5>li:before{content:"" counter(lst-ctn-kix_l4f0b27zjaea-5,lower-roman) ". "}.lst-kix_l4f0b27zjaea-6>li:before{content:"" counter(lst-ctn-kix_l4f0b27zjaea-6,decimal) ". "}ol.lst-kix_99al7u6eb175-0.start{counter-reset:lst-ctn-kix_99al7u6eb175-0 0}.lst-kix_q7lc7dosa7qm-1>li:before{content:"-  "}.lst-kix_ko0xls73w40n-4>li:before{content:"-  "}.lst-kix_99al7u6eb175-5>li{counter-increment:lst-ctn-kix_99al7u6eb175-5}.lst-kix_9w5i4ehhau0k-4>li:before{content:"-  "}ul.lst-kix_q7lc7dosa7qm-0{list-style-type:none}ol.lst-kix_99al7u6eb175-0{list-style-type:none}.lst-kix_l4f0b27zjaea-4>li:before{content:"" counter(lst-ctn-kix_l4f0b27zjaea-4,lower-latin) ". "}ol.lst-kix_l4f0b27zjaea-6.start{counter-reset:lst-ctn-kix_l4f0b27zjaea-6 0}ol.lst-kix_99al7u6eb175-1{list-style-type:none}.lst-kix_99al7u6eb175-2>li:before{content:"" counter(lst-ctn-kix_99al7u6eb175-2,lower-roman) ". "}.lst-kix_q7lc7dosa7qm-2>li:before{content:"-  "}.lst-kix_ko0xls73w40n-3>li:before{content:"-  "}.lst-kix_9w5i4ehhau0k-3>li:before{content:"-  "}ol.lst-kix_l4f0b27zjaea-1{list-style-type:none}ol.lst-kix_99al7u6eb175-8.start{counter-reset:lst-ctn-kix_99al7u6eb175-8 0}ol.lst-kix_l4f0b27zjaea-2{list-style-type:none}ol.lst-kix_l4f0b27zjaea-0{list-style-type:none}.lst-kix_9w5i4ehhau0k-8>li:before{content:"-  "}ol.lst-kix_l4f0b27zjaea-5{list-style-type:none}ol.lst-kix_l4f0b27zjaea-6{list-style-type:none}ol.lst-kix_l4f0b27zjaea-3{list-style-type:none}ol.lst-kix_l4f0b27zjaea-4{list-style-type:none}.lst-kix_99al7u6eb175-2>li{counter-increment:lst-ctn-kix_99al7u6eb175-2}.lst-kix_9w5i4ehhau0k-5>li:before{content:"-  "}ul.lst-kix_ko0xls73w40n-2{list-style-type:none}ul.lst-kix_ko0xls73w40n-1{list-style-type:none}ul.lst-kix_ko0xls73w40n-0{list-style-type:none}ol.lst-kix_l4f0b27zjaea-7{list-style-type:none}ol.lst-kix_l4f0b27zjaea-8{list-style-type:none}.lst-kix_9w5i4ehhau0k-6>li:before{content:"-  "}ul.lst-kix_ko0xls73w40n-6{list-style-type:none}ul.lst-kix_ko0xls73w40n-5{list-style-type:none}ul.lst-kix_ko0xls73w40n-4{list-style-type:none}ul.lst-kix_ko0xls73w40n-3{list-style-type:none}ol.lst-kix_l4f0b27zjaea-8.start{counter-reset:lst-ctn-kix_l4f0b27zjaea-8 0}.lst-kix_9w5i4ehhau0k-7>li:before{content:"-  "}ul.lst-kix_ko0xls73w40n-8{list-style-type:none}ul.lst-kix_ko0xls73w40n-7{list-style-type:none}ol.lst-kix_l4f0b27zjaea-2.start{counter-reset:lst-ctn-kix_l4f0b27zjaea-2 0}.lst-kix_agh5cx7a3fgl-6>li:before{content:"-  "}.lst-kix_99al7u6eb175-3>li{counter-increment:lst-ctn-kix_99al7u6eb175-3}ol.lst-kix_99al7u6eb175-1.start{counter-reset:lst-ctn-kix_99al7u6eb175-1 0}.lst-kix_agh5cx7a3fgl-7>li:before{content:"-  "}ol.lst-kix_99al7u6eb175-2.start{counter-reset:lst-ctn-kix_99al7u6eb175-2 0}.lst-kix_agh5cx7a3fgl-5>li:before{content:"-  "}.lst-kix_99al7u6eb175-6>li{counter-increment:lst-ctn-kix_99al7u6eb175-6}.lst-kix_l4f0b27zjaea-1>li{counter-increment:lst-ctn-kix_l4f0b27zjaea-1}.lst-kix_agh5cx7a3fgl-4>li:before{content:"-  "}.lst-kix_agh5cx7a3fgl-3>li:before{content:"-  "}ul.lst-kix_a7vqfvyrill0-8{list-style-type:none}ol.lst-kix_l4f0b27zjaea-1.start{counter-reset:lst-ctn-kix_l4f0b27zjaea-1 0}.lst-kix_agh5cx7a3fgl-0>li:before{content:"-  "}.lst-kix_agh5cx7a3fgl-2>li:before{content:"-  "}.lst-kix_l4f0b27zjaea-4>li{counter-increment:lst-ctn-kix_l4f0b27zjaea-4}.lst-kix_agh5cx7a3fgl-1>li:before{content:"-  "}ul.lst-kix_a7vqfvyrill0-0{list-style-type:none}ul.lst-kix_a7vqfvyrill0-1{list-style-type:none}ul.lst-kix_a7vqfvyrill0-2{list-style-type:none}.lst-kix_n1ot8ade5hg0-2>li:before{content:"-  "}ul.lst-kix_a7vqfvyrill0-3{list-style-type:none}ul.lst-kix_a7vqfvyrill0-4{list-style-type:none}.lst-kix_l4f0b27zjaea-7>li{counter-increment:lst-ctn-kix_l4f0b27zjaea-7}.lst-kix_n1ot8ade5hg0-3>li:before{content:"-  "}ul.lst-kix_a7vqfvyrill0-5{list-style-type:none}ul.lst-kix_a7vqfvyrill0-6{list-style-type:none}ul.lst-kix_a7vqfvyrill0-7{list-style-type:none}.lst-kix_l4f0b27zjaea-5>li{counter-increment:lst-ctn-kix_l4f0b27zjaea-5}ul.lst-kix_n1ot8ade5hg0-0{list-style-type:none}ul.lst-kix_n1ot8ade5hg0-1{list-style-type:none}ul.lst-kix_n1ot8ade5hg0-2{list-style-type:none}ol.lst-kix_l4f0b27zjaea-7.start{counter-reset:lst-ctn-kix_l4f0b27zjaea-7 0}.lst-kix_99al7u6eb175-0>li{counter-increment:lst-ctn-kix_99al7u6eb175-0}ul.lst-kix_n1ot8ade5hg0-7{list-style-type:none}ul.lst-kix_n1ot8ade5hg0-8{list-style-type:none}ul.lst-kix_n1ot8ade5hg0-3{list-style-type:none}ul.lst-kix_n1ot8ade5hg0-4{list-style-type:none}ul.lst-kix_n1ot8ade5hg0-5{list-style-type:none}ul.lst-kix_n1ot8ade5hg0-6{list-style-type:none}.lst-kix_l4f0b27zjaea-6>li{counter-increment:lst-ctn-kix_l4f0b27zjaea-6}.lst-kix_l4f0b27zjaea-3>li{counter-increment:lst-ctn-kix_l4f0b27zjaea-3}ol.lst-kix_99al7u6eb175-7.start{counter-reset:lst-ctn-kix_99al7u6eb175-7 0}.lst-kix_99al7u6eb175-8>li{counter-increment:lst-ctn-kix_99al7u6eb175-8}ul.lst-kix_q7lc7dosa7qm-4{list-style-type:none}ul.lst-kix_q7lc7dosa7qm-3{list-style-type:none}.lst-kix_l4f0b27zjaea-2>li{counter-increment:lst-ctn-kix_l4f0b27zjaea-2}ul.lst-kix_q7lc7dosa7qm-2{list-style-type:none}.lst-kix_l4f0b27zjaea-8>li{counter-increment:lst-ctn-kix_l4f0b27zjaea-8}ul.lst-kix_q7lc7dosa7qm-1{list-style-type:none}ul.lst-kix_q7lc7dosa7qm-8{list-style-type:none}ul.lst-kix_q7lc7dosa7qm-7{list-style-type:none}ul.lst-kix_q7lc7dosa7qm-6{list-style-type:none}ul.lst-kix_q7lc7dosa7qm-5{list-style-type:none}.lst-kix_99al7u6eb175-7>li{counter-increment:lst-ctn-kix_99al7u6eb175-7}ol.lst-kix_99al7u6eb175-4.start{counter-reset:lst-ctn-kix_99al7u6eb175-4 0}ol.lst-kix_l4f0b27zjaea-5.start{counter-reset:lst-ctn-kix_l4f0b27zjaea-5 0}ol.lst-kix_l4f0b27zjaea-4.start{counter-reset:lst-ctn-kix_l4f0b27zjaea-4 0}ul.lst-kix_agh5cx7a3fgl-7{list-style-type:none}ul.lst-kix_agh5cx7a3fgl-8{list-style-type:none}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}.lst-kix_99al7u6eb175-4>li{counter-increment:lst-ctn-kix_99al7u6eb175-4}.lst-kix_99al7u6eb175-1>li{counter-increment:lst-ctn-kix_99al7u6eb175-1}ul.lst-kix_agh5cx7a3fgl-1{list-style-type:none}ul.lst-kix_agh5cx7a3fgl-2{list-style-type:none}ul.lst-kix_agh5cx7a3fgl-0{list-style-type:none}ul.lst-kix_agh5cx7a3fgl-5{list-style-type:none}ul.lst-kix_agh5cx7a3fgl-6{list-style-type:none}ul.lst-kix_agh5cx7a3fgl-3{list-style-type:none}ul.lst-kix_agh5cx7a3fgl-4{list-style-type:none}ol.lst-kix_99al7u6eb175-5.start{counter-reset:lst-ctn-kix_99al7u6eb175-5 0}ol{margin:0;padding:0}table td,table th{padding:0}.c18{color:#666666;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Ubuntu";font-style:normal}.c6{padding-top:14pt;padding-bottom:4pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c7{padding-top:16pt;padding-bottom:4pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c13{padding-top:12pt;padding-bottom:4pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c3{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Ubuntu";font-style:normal}.c12{padding-top:18pt;padding-bottom:6pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c5{color:#666666;font-weight:700;text-decoration:none;vertical-align:baseline;font-size:12pt;font-family:"Ubuntu";font-style:normal}.c11{color:#434343;text-decoration:none;vertical-align:baseline;font-size:14pt;font-family:"Ubuntu";font-style:normal}.c14{color:#000000;text-decoration:none;vertical-align:baseline;font-size:16pt;font-family:"Ubuntu";font-style:normal}.c1{padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c9{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.c16{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.c0{padding:0;margin:0}.c15{margin-left:72pt;padding-left:0pt}.c10{color:inherit;text-decoration:inherit}.c4{margin-left:36pt;padding-left:0pt}.c8{font-weight:700}.c2{height:11pt}.c19{margin-left:72pt}.c17{margin-left:36pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Ubuntu";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Ubuntu"}p{margin:0;color:#000000;font-size:11pt;font-family:"Ubuntu"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Ubuntu";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-weight:700;font-size:16pt;padding-bottom:6pt;font-family:"Ubuntu";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-weight:700;font-size:14pt;padding-bottom:4pt;font-family:"Ubuntu";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-weight:700;font-size:12pt;padding-bottom:4pt;font-family:"Ubuntu";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Ubuntu";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Ubuntu";line-height:1.15;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c16 doc-content"><h2 class="c12" id="h.feiiptknrerw"><span class="c8 c14">Introduction</span></h2><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">URL shortener is one of the most classic and simplest system design problems, yet there are so many incorrect solutions on the internet that I can&rsquo;t stay silent any longer. As a Software Engineer at Microsoft working on a high-load Presence Service, I know what it takes to build a system capable of handling millions of requests per second.</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span>PoC source code: </span><span class="c9"><a class="c10" href="https://www.google.com/url?q=https://github.com/andreyka26-git/andreyka26-distributed-systems/tree/main/UrlShortener&amp;sa=D&amp;source=editors&amp;ust=1760527116808704&amp;usg=AOvVaw2h0y3lV42MhZ0i4_YNPEy4">andreyka26-distributed-systems</a></span></p><h2 class="c12" id="h.htovdni7tl1k"><span class="c14 c8">1 Requirements</span></h2><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">Every system design discussion begins with clarifying the requirements. These may vary depending on the company and the interviewer, so I will present the most common ones.</span></p><h3 class="c7" id="h.p6lugtlyv7y3"><span class="c8 c11">Functional Requirements</span></h3><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">Functional requirements describe how the application works from the user&rsquo;s or client&rsquo;s perspective.</span></p><p class="c1 c2"><span class="c3"></span></p><ol class="c0 lst-kix_99al7u6eb175-0 start" start="1"><li class="c1 c4 li-bullet-0"><span class="c3">The system creates and returns a short URL given a long original URL</span></li><li class="c1 c4 li-bullet-0"><span>When a user accesses the short URL, the system redirects them to the long original URL</span></li><li class="c1 c4 li-bullet-0"><span>Follow-up: Analytics - each time the link is clicked, notify an external analytics service</span></li></ol><p class="c1 c2"><span class="c3"></span></p><h3 class="c7" id="h.189pus5kfo38"><span class="c11 c8">Non Functional Requirements</span></h3><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">Non-functional requirements cover the technical aspects of the solution, including typical architectural concerns such as availability, consistency, scalability, and latency.</span></p><p class="c1 c2"><span class="c3"></span></p><ol class="c0 lst-kix_l4f0b27zjaea-0 start" start="1"><li class="c1 c4 li-bullet-0"><span class="c8">Short URL Uniqueness - our CORE problem</span><span class="c3">: a Short URL must not point to more than one Long URL.</span></li></ol><p class="c1 c2 c17"><span class="c3"></span></p><ol class="c0 lst-kix_l4f0b27zjaea-0" start="2"><li class="c1 c4 li-bullet-0"><span class="c8">Scalability / Traffic / Load</span><span class="c3">: ChatGPT reports that Bitly creates 10-30 million links per day. Let&rsquo;s push that to the extreme - 300 million links per day. I would assume at least ten times more read traffic, since people mostly click on links rather than create them.</span></li></ol><ol class="c0 lst-kix_l4f0b27zjaea-1 start" start="1"><li class="c1 c15 li-bullet-0"><span>Write traffic: </span><span class="c8">300M Daily</span><span>&nbsp;= </span><span class="c8">3.4k rps</span><span class="c3">.</span></li><li class="c1 c15 li-bullet-0"><span>Read traffic: </span><span class="c8">3B Daily</span><span>&nbsp;= </span><span class="c8">34k rps</span><span class="c3">.</span></li><li class="c1 c15 li-bullet-0"><span class="c3">Memory: 2 trillion URLs - 20 years of operation with 300M new URLs daily.</span></li></ol><p class="c1 c2 c19"><span class="c3"></span></p><ol class="c0 lst-kix_l4f0b27zjaea-0" start="3"><li class="c1 c4 li-bullet-0"><span class="c8">CAP (Availability vs Consistency)</span><span>&nbsp;- We will prioritize high availability, which means adopting </span><span class="c8">eventual consistency</span><span class="c3">. We understand that it may take some time before links are available everywhere for redirection.</span></li></ol><p class="c1 c2"><span class="c3"></span></p><ol class="c0 lst-kix_l4f0b27zjaea-0" start="4"><li class="c1 c4 li-bullet-0"><span class="c8">Traffic type: spiky</span><span class="c3">. We clearly face a &ldquo;celebrity problem&rdquo; - there is a huge difference between me and Trump posting a link on social media.</span></li></ol><p class="c1 c2"><span class="c3"></span></p><h3 class="c7" id="h.2h4yjt4s33k6"><span class="c11 c8">Short URL Uniqueness - our CORE requirement</span></h3><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">Every system design has some &ldquo;special&rdquo; core requirement or problem to solve, all other requirements can be trivially solved using well-known patterns.</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">In our case the problem is that we cannot allow one Short URL to point to two different Long URLs.</span></p><h4 class="c6" id="h.1k16lurdogle"><span class="c5">URL Length</span></h4><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">We agreed earlier that we want the URLs to be as short as possible, but clearly there is a tradeoff: the shorter the URL, the fewer combinations we can make.</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span>We have </span><span class="c8">62 characters</span><span class="c3">&nbsp;for URL symbols: 26 lowercase + 26 uppercase letters + 10 digits. We cannot include special characters because they can be misinterpreted by browsers, e.g. `?` and `&amp;`</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">Consider an url with a single character available. In that case we would have only 62 possibilities. After generating 62^1 unique URLs, any next character we choose will produce a URL we&#39;ve already generated. If we want more, we need to add one more character, and then we would have 62^2 = 3844 possibilities.</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">To operate for 20 years given 300M new URLs daily, we need 300M * 365 * 20 = 2 190 000 000 000 (2 trillion) URLs.</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">With simple math, 7 characters are enough to satisfy our requirements for the next 20 years:</span></p><p class="c1"><span class="c3">`62^7 = 3 521 614 606 208 (3 trillions) &gt; 2 190 000 000 000 (2 trillions)`</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">Now, the most interesting question: HOW can we generate these 7-character valuesso they are unique?</span></p><p class="c1 c2"><span class="c3"></span></p><h4 class="c6" id="h.lji4eljzj789"><span class="c5">Direct Long URL usage</span></h4><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">```cs</span></p><p class="c1"><span class="c3">var urlBytes = Encoding.UTF8.GetBytes(originalUrl);</span></p><p class="c1"><span class="c3">var shortUrl = Base62Utils.ToBase62(urlBytes);</span></p><p class="c1"><span class="c3">```</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">We&rsquo;ll have a few problems with this approach: the original URL might be longer than 7 characters; trimming it leads to collisions, and users cannot create different short URLs pointing to the same long URL. </span></p><p class="c1"><span class="c3">Conclusion: a bad option.</span></p><h4 class="c6" id="h.cqn3jp5oo3zp"><span class="c5">Random generation</span></h4><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">```cs</span></p><p class="c1"><span class="c3">var chars = new char[7];</span></p><p class="c1"><span class="c3">for (int i = 0; i &lt; 7; i++)</span></p><p class="c1"><span class="c3">{</span></p><p class="c1"><span class="c3">&nbsp; &nbsp; chars[i] = Base62Characters[_random.Next(Base62Characters.Length)];</span></p><p class="c1"><span class="c3">}</span></p><p class="c1"><span class="c3">return new string(chars);</span></p><p class="c1"><span class="c3">```</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">It would be ideal, since we can directly create base62 strings without transformations, but again - collisions. Of course we can retry, but how many times? What if all 3-5 retries led to collisions? Should we fail the request and ask users to try again? </span></p><p class="c1"><span class="c3">Conclusion: not the best option.</span></p><p class="c1 c2"><span class="c3"></span></p><h4 class="c6" id="h.7rbzbvlnrcxu"><span class="c5">Long URL Hashing</span></h4><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">```cs</span></p><p class="c1"><span class="c3">using var sha256 = SHA256.Create();</span></p><p class="c1"><span class="c3">var hashBytes = sha256.ComputeHash(Encoding.UTF8.GetBytes(originalUrl));</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">var shortUrl = Base62Utils.ToBase62(hashBytes);</span></p><p class="c1"><span class="c3">```</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">Hashing can naturally produce collisions, just like the Random generation approach, apart from the fact that hashing is more CPU intensive, and requires an additional transformation to base62.</span></p><p class="c1"><span class="c3">Conclusion: a bad option.</span></p><p class="c1 c2"><span class="c3"></span></p><h4 class="c6" id="h.7sysx1ceafk6"><span class="c5">GUID generation</span></h4><p class="c1 c2"><span class="c3"></span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">```cs</span></p><p class="c1"><span class="c3">var guidBytes = guid.ToByteArray();</span></p><p class="c1"><span class="c3">var shortUrl = Base62Utils.ToBase62(guidBytes);</span></p><p class="c1"><span class="c3">```</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">GUIDs are naturally unique and might seem like a good option, however they are still too long (22 base62 characters). Trimming them will lead to collisions.</span></p><p class="c1 c2"><span class="c3"></span></p><h4 class="c6" id="h.10epe8jcnjyy"><span class="c5">Unique Number</span></h4><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">```cs</span></p><p class="c1"><span class="c3">var id = await _uniqueIdClient.GetUniqueIdAsync();</span></p><p class="c1"><span class="c3">var scrambledId = ScrambleId(id);</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">var shortUrl = Base62Utils.ToBase62(scrambledId).PadLeft(7, &#39;0&#39;);</span></p><p class="c1"><span class="c3">```</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">The north-star solution here is to use a unique number generator and convert the number to base62. Since the maximum number of unique Short URLs we can create is 4 trillion - we need a 42-bits number.</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">62 ^ 7 = 3 521 614 606 208</span></p><p class="c1"><span class="c3">2 ^ 42 = 4 398 046 511 104</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">Note: `ScrambleId` is needed for numbers like &ldquo;1&rdquo;, &ldquo;2&rdquo;, which would otherwise give us &ldquo;0000001&rdquo; and &ldquo;0000002&rdquo; short URLs</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">While the number is unique, the Short URL is unique as well.</span></p><p class="c1 c2"><span class="c3"></span></p><h3 class="c7" id="h.u99k3up7ch75"><span class="c11 c8">API Design</span></h3><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">We&rsquo;ll need 2 endpoints:</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">`POST /shorturl {&lsquo;longUrl&rsquo;: &lsquo;&lt;lurl&gt;}` will generate a Short URL `&lt;surl&gt;`, store it as mapping `&lt;surl&gt;: &lt;lurl&gt;` and return it to the caller.</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">`GET /&lt;surl&gt;` - will resolve `&lt;lurl&gt;` from the storage, and return 301 Redirect to `&lt;lurl&gt;`</span></p><h2 class="c12" id="h.po4cpy8naqxq"><span class="c14 c8">2 Satisfy Functional requirements</span></h2><p class="c1"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 369.33px;"><img alt="" src="images/image1.png" style="width: 624.00px; height: 369.33px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span>As our first step we should satisfy functional requirements </span><span class="c8">without thinking about scaling, availability, high load</span><span class="c3">, etc. Just something that works for a couple of users.</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">We can create an API with the two endpoints described above. Use SQL database with a primary auto-increment ID table for unique number generation. Add main storage for `Short URL -&gt; Long URL` mapping, with indices for faster lookup.</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">The POST endpoint will get the next unique number, generate a Short URL and insert the mapping into main storage.</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">The GET endpoint will look up the long URL in the storage given the short URL and return a 301 Redirect.<br></span></p><h2 class="c12" id="h.z71tul2dp8e3"><span class="c14 c8">3 Satisfy Non-Functional Requirements</span></h2><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 390.67px;"><img alt="" src="images/image2.png" style="width: 624.00px; height: 390.67px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c1 c2"><span class="c3"></span></p><h3 class="c7" id="h.z7qm4u3u843c"><span class="c11 c8">High Scalability</span></h3><p class="c1 c2"><span class="c3"></span></p><h4 class="c6" id="h.dmin7xriygfy"><span class="c5">API scaling</span></h4><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">API scaling is trivially solved by replicating the API across multiple instances with several LBs to distribute the load, since the API is stateless.</span></p><p class="c1 c2"><span class="c3"></span></p><h4 class="c6" id="h.9w3oxbyfqxjm"><span class="c5">URLs storage scaling</span></h4><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">Our mapping record `shourtUrl -&gt; longUrl` will take around 200-250 bytes. Overall we will need 250 * 2 trillion records = 500 Terabytes.</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span>URLs storage is </span><span class="c8">load-intensive</span><span class="c3">&nbsp;rather than memory-intensive, and from a load perspective we definitely have many more reads than writes `reads &gt;&gt; writes`.</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">We need to scale writes, as 3-4k rps is a bit too much for a single node. In this case, the solution is straightforward - apply sharding using &ldquo;short URL&rdquo; as sharding key. For easy rebalancing use either consistent or rendezvous hashing, or hash-slots sharding (the one Redis uses). This will split our writes evenly between shard nodes.</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">For read scaling, we can put a few in-memory cache replicas (e.g. Redis) near the main storage shard + possibly leader-follower replicas (see availability section).</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">To decrease latency, we can additionally put a sharded LRU Distributed Cache in all Regions (DCs), and configure LBs to direct the users to the closest node.</span></p><p class="c1 c2"><span class="c3"></span></p><h4 class="c6" id="h.9l5wap4brmvl"><span class="c5">Unique Number Storage scaling</span></h4><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">This is one of the most poorly solved problems in publicly available solutions. Remember, our initial solution was just to keep a SQL db with a single table and a single Primary AUTO INCREMENT Id.</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">What is the problem here? First of all, it is a single point of failure, and it is not easy to solve with replication (see availability section). Second, 3.5k writes per second is doable for an ideally optimised and scalable Postgres instance, but I want to have the ability to scale to even more writes.</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">The distributed unique number generator is definitely a separate system design, but let&rsquo;s broadly consider the options here.</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">Some bad options:</span></p><ul class="c0 lst-kix_ko0xls73w40n-0 start"><li class="c1 c4 li-bullet-0"><span class="c8">create a static number of shards</span><span class="c3">, and make them handle `id % N` numbers, e.g. shard1 handles all even numbers and shard2 handles all odd numbers. It is better than a single instance, but it is not flexible - there is no way to downscale or upscale without losing either the uniqueness property or the number space.</span></li><li class="c1 c4 li-bullet-0"><span class="c8">assign each shard a range</span><span class="c3">, e.g. shard1 handles numbers from 0 to 1000, shard2 &nbsp;- from 1001 to 2000, and so on. &nbsp;This solution has poor maintainability: when range is exhausted, it is hard to assign a new one. Besides that, it is impossible to add new nodes without knowing the state of other nodes. Not even mentioning that not every database can start Primary Id from a predefined offset.</span></li></ul><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">I see here only 2 good solutions.</span></p><p class="c1 c2"><span class="c3"></span></p><h5 class="c13" id="h.17t330qqww4l"><span class="c18">Prefixed shards</span></h5><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 392.00px;"><img alt="" src="images/image4.png" style="width: 624.00px; height: 392.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c1"><span class="c3">We reserve a couple of bits of the number for shard id. Let&rsquo;s say we know we will have no more than 16 shards - then we reserve the first 4 bits of the unique id. </span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">Now, each shard deals with exactly the same sequence of PRIMARY AUTOINCREMENT IDs (from 0 to 2^64). Every single shard appends its shard id (unique per shard) at the beginning. It can be done on the database level or the API level.</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">We just need to make sure that no two shards have the same ID (via config, or by embedding it in a table in the shard itself).</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">This solution easily allows adding new shards without knowing the state of other shards. However, downscaling would be a bit challenging.</span></p><p class="c1 c2"><span class="c3"></span></p><h5 class="c13" id="h.md8ukida522a"><span class="c9"><a class="c10" href="https://www.google.com/url?q=https://en.wikipedia.org/wiki/Snowflake_ID&amp;sa=D&amp;source=editors&amp;ust=1760527116823549&amp;usg=AOvVaw3qgORClFADPu14oHhjJb0Q">Snowflake Id</a></span></h5><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 366.67px;"><img alt="" src="images/image3.png" style="width: 624.00px; height: 366.67px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span>This is the </span><span class="c9"><a class="c10" href="https://www.google.com/url?q=https://en.wikipedia.org/wiki/Snowflake_ID&amp;sa=D&amp;source=editors&amp;ust=1760527116823870&amp;usg=AOvVaw2v8mF9TpW5-VGkvHFAGDjS">north-star solution</a></span><span class="c3">, because it is fully stateless, meaning it does NOT require any storage whatsoever. It is easy to upscale and downscale, and it is faster than other options.</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">The idea is the same as in early versions of GUID. We use 64 bits for numbers.</span></p><p class="c1"><span class="c3">41 bits - timestamp</span></p><p class="c1"><span class="c3">10 bits - machine id</span></p><p class="c1"><span class="c3">12 bits - sequence number</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">Whenever some API receives a request to give the unique number, it takes the current UTC time (milliseconds precision), appends its machine id (which should be unique across all nodes) and appends the Sequence Number.</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">The sequence number is 1 by default. It is only required in the cases, when the same API receives 2 or more requests at the same millisecond, so each request will get a different sequence id.</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">There is only one drawback in this solution. Since our number is at max 2 ^ 64, we cannot fit it into a 62 ^ 7 Short URL value, and in this case we would need to use 11 characters instead of 7.</span></p><p class="c1"><span class="c3"><br>62 ^ 7 &nbsp; = &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 3 521 614 606 208</span></p><p class="c1"><span class="c3">2 ^ 64 &nbsp; = 18 446 744 073 709 600 000</span></p><p class="c1"><span class="c3">62 ^ 11 = 52 036 560 683 837 100 000</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">Actually we don&rsquo;t need all 64 bits, 42 bits would be perfectly fine for 2 trillion URLs<br>62 ^ 7 = 3 521 614 606 208</span></p><p class="c1"><span class="c3">2 ^ 42 = 4 398 046 511 104</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">Unfortunately, we cannot shrink it to 42 bits, as it is not enough for Snowflake ids. The maximum we can shrink to is 55 bits =&gt; 10 characters:</span></p><ul class="c0 lst-kix_a7vqfvyrill0-0 start"><li class="c1 c4 li-bullet-0"><span class="c3">39 bits for milliseconds, which will give us 17 years of service</span></li><li class="c1 c4 li-bullet-0"><span class="c3">6 bits for machineid (64)</span></li><li class="c1 c4 li-bullet-0"><span class="c3">10 bits for SN (1024)</span></li></ul><p class="c1 c2"><span class="c3"></span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1 c2"><span class="c3"></span></p><h3 class="c7" id="h.1p2jqcgfjse6"><span class="c11 c8">High availability</span></h3><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">High availability is usually achieved through replication.</span></p><p class="c1 c2"><span class="c3"></span></p><h4 class="c6" id="h.j3wcluwk2e37"><span class="c5">API availability</span></h4><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">It&rsquo;s trivial: just add additional API instances, so that if some APIs fail, the load balancer will direct traffic to the ones that are alive</span></p><p class="c1 c2"><span class="c3"></span></p><h4 class="c6" id="h.4y9lirqrk3m"><span class="c5">URLs storage availability</span></h4><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">If we can accept rare data loss (e.g., during leader election), we can use leader-follower asynchronous replication. When data loss is not acceptable, there is nothing else except Raft-based replication, where we can afford to lose a minority of nodes, or cannot use replication at all.</span></p><p class="c1 c2"><span class="c3"></span></p><h4 class="c6" id="h.3bslv15k1z9y"><span class="c5">Unique Number Storage availability</span></h4><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">For Prefixed shards solution, we cannot afford data loss here - so we definitely cannot use Leader-Follower async replication. Moreover, synchronous Leader-Follower replication does not fit our needs either, as we would not be resilient against replica loss.</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">This is the rare case, when we can use shards as availability guarantees: if shard1 dies, the API can round-robin to shard2, which is alive.</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">In the case of the Snowflake Id solution, due to its stateless nature, high availability is trivially solved with replication as explained in the API availability section.</span></p><p class="c1 c2"><span class="c3"></span></p><h2 class="c12" id="h.lc9c00v63c2m"><span class="c14 c8">Conclusion</span></h2><p class="c1 c2"><span class="c3"></span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">You might notice that we didn&rsquo;t cover the follow-up with analytics, as this is something you can suggest in the comments section!</span></p><p class="c1 c2"><span class="c3"></span></p><p class="c1"><span class="c3">I would appreciate your feedback on this system design solution. Please share your thoughts and subscribe on Instagram and Telegram to be part of the FAANG SWE community.</span></p><p class="c1 c2"><span class="c3"></span></p></body></html>